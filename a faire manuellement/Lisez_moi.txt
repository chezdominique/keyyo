Il faut copier coller ce fichier dans le répertoire /controllers de prestashop


33430966096


Voici les partie du code modifié dans le controller



// A ajouter dans 	public function __construct()

        // Ajout pour les appels AJAX du module KEYYO
        $this->addJquery();
        $this->addJS(_PS_MODULE_DIR_ . 'keyyo/views/js/adminkeyyo.js');
        $this->addCSS(_PS_MODULE_DIR_ . 'keyyo/views/css/adminkeyyo.css');

// A ajouter dans 	public function initContent()

		// Vérification du numéro d'appel employé pour KEYYO
        $keyyo_caller = $this->context->employee->getKeyyoCaller();
        if (!$keyyo_caller) {
            $this->errors[] = 'Veuillez configurer votre numéro d\'appel dans l\'onglet Administration > Employés ';
        }
// A modifier dans 	public function initContent()

		$this->fields_list = array_merge($this->fields_list, array(

		'phone' => array(
				'title' => $this->l('Tel'),
				'align' => 'text-center',
				'type' => 'text',
				'orderby' => false,
				'havingFilter' => true,
				'callback' => 'makePhoneCall' // Keyyo
			),


// A ajouter à la fin du controller ou dans un override

    /**
     * Création de l'url pour l'appel ajax vers le client depuis un poste KEYYO
     * 02/08/2016 Dominique
     * @param $number
     * @param $params
     * @return string
     */
    public function makePhoneCall($number, $params)
    {
        $keyyo_link ='';
        $phoneNumbers = split(':', $number);
        foreach ($phoneNumbers as $phoneNumber) {
            $NumberK = $this->sanitizePhonenumber($phoneNumber);
            $ln = strlen($NumberK);

            $display_message = ($ln != 10 && $ln > 0) ? '<i class="icon-warning text-danger"></i>' : '';

            $keyyo_link .= $display_message . ' <a class="keyyoNumber" href="' . Context::getContext()->link->getAdminLink('AdminCustomers');
            $keyyo_link .= '&ajax=1&action=KeyyoCall';
            $keyyo_link .= '&CALLEE=' . $NumberK;
            $keyyo_link .= '&CALLE_NAME=' . $params['lastname'] . '_' . $params['firstname'];
            $keyyo_link .= '" class="keyyo_link">' . $NumberK . '</a>';
        }
        return $keyyo_link;
    }

    private function sanitizePhoneNumber($number)
    {
        $pattern = str_split(Configuration::get('KEYYO_NUMBER_FILTER'));
        $number = str_replace($pattern, '', $number);
        if (substr($number, 0, 1) != '0') {
            $number = '0' . $number;
        }

        return $number;
    }

    public function ajaxProcessKeyyoCall()
    {

        $keyyo_url = Configuration::get('KEYYO_URL');
        $account = $this->context->employee->getKeyyoCaller();
        $callee = Validate::isString(Tools::getValue('CALLEE'))?Tools::getValue('CALLEE'):'';
        $calle_name = Validate::isString(Tools::getValue('CALLE_NAME'))?Tools::getValue('CALLE_NAME'):'';

        if (!$account) {
            $return = Tools::jsonEncode(array('msg' => 'Veuillez configurer votre numéro de compte KEYYO.'));
            die($return);
        }

        if (!$callee || !$calle_name) {
            $return = Tools::jsonEncode(array('msg' => 'Il manque une information pour composer le numéro.'));
            die($return);
        } else {
            $keyyo_link = $keyyo_url . '?ACCOUNT=' . $account;
            $keyyo_link .= '&CALLEE=' . $callee;
            $keyyo_link .= '&CALLE_NAME=' . $calle_name;

            $fp = fopen($keyyo_link, 'r');
            $buffer = fgets($fp, 4096);
            fclose($fp);

            if ($buffer == 'OK') {
                $return = Tools::jsonEncode(array('msg' => 'Appel du ' . $callee . ' en cours.'));
                die($return);
            } else {
                $return = Tools::jsonEncode(array('msg' => 'Problème lors de l\'appel.'));
                die($return);
            }
        }
    }